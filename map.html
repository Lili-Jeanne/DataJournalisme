<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartes des Coiffeurs en Dordogne ou Gironde</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    height: 100vh; 
    overflow: hidden; 
    background: #F6DDB4;
    color: #4b2e27;
}
.container { display: flex; height: 100vh; }
/* === SIDEBAR === */
.sidebar { 
    width: 320px; 
    background: linear-gradient(135deg, #A22D27 0%, #C2374C 100%);
    color: #F6DDB4;
    padding: 25px; 
    overflow-y: auto; 
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    z-index: 1001;
}
h1 { font-size: 22px; margin-bottom: 8px; font-weight: 600; }
.subtitle { font-size: 13px; opacity: 0.9; margin-bottom: 20px; }
/* === MENU MOBILE === */
.menu-toggle {
    display: none;
    position: fixed;
    top: 20px;
    left: 20px;
    background: #A22D27;
    color: #F6DDB4;
    border: 2px solid #F6DDB4;
    border-radius: 10px;
    padding: 12px;
    cursor: pointer;
    z-index: 1002;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
.menu-toggle:hover {
    background: #C2374C;
}
.menu-toggle svg {
    width: 24px;
    height: 24px;
    display: block;
}
/* === STATS BOX === */
.stats { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px; 
    margin-bottom: 20px;
}
.stat-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
.stat-value { font-weight: bold; font-size: 16px; }
/* === MAP SELECTOR === */
.map-selector { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px; 
    margin-bottom: 20px;
}
.map-selector h3 { font-size: 15px; margin-bottom: 12px; }
.map-btn {
    width: 100%; padding: 10px; margin-bottom: 8px;
    border: 2px solid rgba(246,221,180,0.3);
    background: rgba(246,221,180,0.1);
    color: #F6DDB4;
    border-radius: 8px;
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.3s;
}
.map-btn:hover { background: rgba(246,221,180,0.25); transform: translateY(-2px); }
.map-btn.active { background: #F6DDB4; color: #A22D27; border-color: #F6DDB4; }
/* === FILTERS === */
.filters { margin-bottom: 20px; }
.filter-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #F6DDB4; }
.filter-btn {
    width: 100%; padding: 10px; margin-bottom: 8px;
    border: 2px solid rgba(246,221,180,0.3);
    background: rgba(246,221,180,0.1);
    color: #F6DDB4;
    border-radius: 8px;
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.3s;
}
.filter-btn:hover { background: rgba(246,221,180,0.25); transform: translateY(-2px); }
.filter-btn.active { background: #F6DDB4; color: #A22D27; border-color: #F6DDB4; }
/* === LEGEND === */
.legend { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px;
}
.legend-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; color:#F6DDB4; }
.legend-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; }
.legend-color { width: 18px; height: 18px; border-radius: 50%; margin-right: 10px; border: 2px solid #F6DDB4; }
.with-site { background: #A6BE4C; }
.without-site { background: #A22D27; }
/* === HEATMAP LEGEND === */
.heatmap-legend { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px; 
    margin-top: 15px; 
    display:none; 
}
.heatmap-gradient { height: 20px; border-radius: 4px; margin-top: 10px; background: linear-gradient(to right, #0000ff, #00ffff, #00ff00, #ffff00, #ff8000, #ff0000); }
.heatmap-labels { display: flex; justify-content: space-between; font-size: 11px; margin-top: 5px; color:#F6DDB4; }
/* === MAPS === */
.maps-container { flex: 1; display: flex; flex-direction: column; }
#map-interactive, #map-heatmap { height: 100%; display: none; }
#map-interactive.active, #map-heatmap.active { display: block; }
/* === POPUPS === */
.popup-content { min-width: 200px; }
.popup-address { font-weight: 600; margin-bottom: 8px; color: #A22D27; font-size: 13px; }
.popup-siren { font-size: 12px; color: #5a463c; margin-bottom: 8px; }
.popup-site { display: flex; align-items: center; gap: 5px; font-size: 12px; }
.popup-site.has-site { color: #A6BE4C; }
.popup-site.no-site { color: #A22D27; }
.popup-link { color: #C2374C; text-decoration: none; font-size: 11px; display: block; margin-top: 6px; }
.popup-link:hover { text-decoration: underline; }
/* === LOADING === */
.loading { 
    position: absolute; top: 50%; left: 50%; 
    transform: translate(-50%, -50%); 
    background: #F6DDB4; 
    padding: 25px 40px; border-radius: 10px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
    z-index: 9999; text-align: center; 
    color: #A22D27;
}
.loading-spinner { 
    width: 40px; height: 40px; 
    border: 3px solid #f3f3f3; 
    border-top: 3px solid #A22D27; 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
    margin: 0 auto 12px; 
}
#loading-counter { font-weight: bold; font-size: 16px; margin-top: 8px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
/* === BOUTON EXPLORE === */
.explore-btn {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: #A22D27;
    color: #F6DDB4;
    border: 2px solid #F6DDB4;
    padding: 12px 22px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    z-index: 1000;
}
.explore-btn:hover {
    background: #C2374C;
    transform: translateY(-2px);
}
.explore-btn svg {
    width: 18px;
    height: 18px;
    margin-left: 8px;
    vertical-align: middle;
    transition: transform 0.3s ease;
}
.explore-btn:hover svg {
    transform: rotate(90deg);
}
/* === RESPONSIVE === */
@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        transform: translateX(-100%);
    }
    .sidebar.open {
        transform: translateX(0);
    }
    .menu-toggle {
        display: block;
    }
    .maps-container {
        width: 100%;
    }
    .explore-btn {
        bottom: 15px;
        right: 15px;
        padding: 10px 18px;
        font-size: 14px;
    }
    h1 { font-size: 20px; }
    .stats { padding: 12px; }
    .stat-item { font-size: 13px; }
}
</style>
</head>
<body>
<!-- Choix du d√©partement -->
<div id="department-choice" style="
    position: fixed; top:0; left:0; width:100%; height:100%; 
    background: rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; 
    z-index:10000; color:#fff; flex-direction:column;
">
    <div style="
        background:#A22D27; padding:30px; border-radius:15px; text-align:center;
        max-width:300px;
    ">
        <h2>Choisissez le d√©partement</h2>
        <p>Quelle r√©gion voulez-vous consulter ?</p>
        <button onclick="startMap('dordogne')" style="
            background:#F6DDB4; color:#A22D27; border:none; padding:10px 20px; margin:10px; border-radius:8px; cursor:pointer;
        ">Dordogne</button>
        <button onclick="startMap('gironde')" style="
            background:#F6DDB4; color:#A22D27; border:none; padding:10px 20px; margin:10px; border-radius:8px; cursor:pointer;
        ">Gironde</button>
    </div>
</div>

<!-- Bouton menu mobile -->
<button class="menu-toggle" onclick="toggleMenu()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
</button>

<div class="container">
    <div class="sidebar" id="sidebar">
        <h1>üíá‚Äç‚ôÄÔ∏è Coiffeurs</h1>
        <p class="subtitle">Analyse de pr√©sence en ligne</p>
        <div class="stats">
            <div class="stat-item"><span>Total:</span><span class="stat-value" id="total-count">0</span></div>
            <div class="stat-item"><span>Avec site web:</span><span class="stat-value" id="with-site-count" style="color:#A6BE4C">0</span></div>
            <div class="stat-item"><span>Sans site web:</span><span class="stat-value" id="without-site-count" style="color:#A22D27">0</span></div>
        </div>

        <div class="map-selector">
            <h3>Type de carte</h3>
            <button class="map-btn active" onclick="switchMap('interactive', event)">üìç Carte interactive</button>
            <button class="map-btn" onclick="switchMap('heatmap', event)">üî• Carte de chaleur (sans site)</button>
        </div>

        <div class="filters">
            <div class="filter-title">Filtrer par:</div>
            <button class="filter-btn active" onclick="filterMarkers('all', event)">Tous les coiffeurs</button>
            <button class="filter-btn" onclick="filterMarkers('with', event)">Avec site web</button>
            <button class="filter-btn" onclick="filterMarkers('without', event)">Sans site web</button>
        </div>

        <div class="legend">
            <div class="legend-title">L√©gende</div>
            <div class="legend-item"><div class="legend-color with-site"></div><span>Avec site internet</span></div>
            <div class="legend-item"><div class="legend-color without-site"></div><span>Sans site internet</span></div>
        </div>

        <div class="heatmap-legend" id="heatmap-legend">
            <div class="legend-title">Intensit√© de la chaleur</div>
            <div class="heatmap-gradient"></div>
            <div class="heatmap-labels">
                <span>Faible</span>
                <span>√âlev√©</span>
            </div>
            <p style="font-size: 11px; margin-top: 10px; opacity: 0.9;">
                Plus la zone est rouge, plus il y a d'entreprises sans site web
            </p>
        </div>
    </div>

    <div class="maps-container">
        <div id="map-interactive" class="active"></div>
        <div id="map-heatmap"></div>
    </div>
</div>

<!-- Bouton Explore -->
<button class="explore-btn"  onclick="window.location.href='index.html'">
  Acceuil
  <svg viewBox="0 0 16 19" xmlns="http://www.w3.org/2000/svg">
    <path d="M7 18C7 18.5523 7.44772 19 8 19C8.55228 19 9 18.5523 9 18H7ZM8.70711 0.292893C8.31658 -0.0976311 7.68342 -0.0976311 7.29289 0.292893L0.928932 6.65685C0.538408 7.04738 0.538408 7.68054 0.928932 8.07107C1.31946 8.46159 1.95262 8.46159 2.34315 8.07107L8 2.41421L13.6569 8.07107C14.0474 8.46159 14.6805 8.46159 15.0711 8.07107C15.4616 7.68054 15.4616 7.04738 15.0711 6.65685L8.70711 0.292893ZM9 18L9 1H7L7 18H9Z"
    fill="#F6DDB4"></path>
  </svg>
</button>

<div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>Chargement des donn√©es...</p>
    <p id="loading-counter">000 / 000</p>
</div>

<script>
let mapInteractive, mapHeatmap, markers = [], heatmapLayer, allData = [], currentFilter = 'all', selectedDept = 'dordogne';

function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function setupMobileMenuClose() {
    if (window.innerWidth <= 768) {
        document.querySelector('.maps-container').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
        });
    }
}

async function startMap(department) {
    selectedDept = department;
    document.getElementById('department-choice').style.display = 'none';
    await initMaps();

    if (selectedDept === 'dordogne') {
        localiserAgences();
    }
}

async function initMaps() {
    let csvFile = 'data_geocoded.csv';
    let center = [45.1847, 0.7213];
    if(selectedDept === 'gironde') {
        csvFile = 'data_geocoded_33.csv';
        center = [44.8378, -0.5792];
    }

    mapInteractive = L.map('map-interactive').setView(center, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(mapInteractive);

    mapHeatmap = L.map('map-heatmap').setView(center, 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(mapHeatmap);

    try {
        const response = await fetch(csvFile);
        if (!response.ok) throw new Error(csvFile + ' introuvable');
        const csvText = await response.text();
        await processData(csvText);
    } catch(e) {
        console.error(e);
        document.getElementById('loading').style.display = 'none';
        alert('Erreur lors du chargement des donn√©es : ' + e.message);
    }
}

async function processData(csvText){
    const lines = csvText.trim().split('\n');
    const total = lines.length - 1;
    const counterElem = document.getElementById('loading-counter');
    const totalElem = document.getElementById('total-count');
    const withElem = document.getElementById('with-site-count');
    const withoutElem = document.getElementById('without-site-count');

    allData = [];
    let withSite = 0, withoutSite = 0;

    for(let i=1; i<lines.length; i++){
        const values = lines[i].split(',');
        if(values.length>=6){
            const lat = parseFloat(values[4]);
            const lon = parseFloat(values[5]);
            if(!isNaN(lat) && !isNaN(lon)){
                const siteWeb = values[2].trim();
                const hasSite = siteWeb.includes('http') && !siteWeb.includes('Non');
                const item = { siren: values[0], url_pappers: values[1], site_web: siteWeb, address: values[3], lat, lon, hasSite };
                allData.push(item);
                addMarker(item);

                if(hasSite) withSite++; else withoutSite++;

                totalElem.textContent = allData.length;
                withElem.textContent = withSite;
                withoutElem.textContent = withoutSite;
                counterElem.textContent = `${i.toString().padStart(3,'0')} / ${total.toString().padStart(3,'0')}`;
            }
        }
        if(i % 50 === 0) await new Promise(r=>setTimeout(r,1));
    }

    document.getElementById('loading').style.display='none';
    setupMobileMenuClose();
}

function getDynamicRadius(zoom){ return Math.min(50, Math.max(15, zoom*4)); }

function addMarker(item){
    const color = item.hasSite?'#10b981':'#ef4444';
    const icon = L.divIcon({ html:`<div style="background-color:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>`, iconSize:[12,12], iconAnchor:[6,6], className:'' });
    const marker = L.marker([item.lat,item.lon],{icon}).addTo(mapInteractive);
    marker.bindPopup(`<div class="popup-content">
        <div class="popup-address">${item.address}</div>
        <div class="popup-siren">SIREN: ${item.siren}</div>
        <div class="popup-site ${item.hasSite?'has-site':'no-site'}">${item.hasSite?'‚úì Site web disponible':'‚úó Pas de site web'}</div>
        ${item.hasSite?`<a href="${item.site_web}" target="_blank" class="popup-link">Visiter le site ‚Üí</a>`:''}
        <a href="${item.url_pappers}" target="_blank" class="popup-link">Voir sur Pappers ‚Üí</a>
    </div>`);
    marker.itemData = item;
    markers.push(marker);
}

function filterMarkers(filter,e){
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn=>btn.classList.remove('active'));
    e.target.classList.add('active');
    markers.forEach(marker=>{
        const show = filter==='all'||(filter==='with' && marker.itemData.hasSite)||(filter==='without' && !marker.itemData.hasSite);
        show?mapInteractive.addLayer(marker):mapInteractive.removeLayer(marker);
    });
    
    if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
}

function switchMap(type,e){
    document.querySelectorAll('.map-btn').forEach(btn=>btn.classList.remove('active'));
    e.target.classList.add('active');

    if(type==='interactive'){
        document.getElementById('map-interactive').classList.add('active');
        document.getElementById('map-heatmap').classList.remove('active');
        document.getElementById('heatmap-legend').style.display='none';
        setTimeout(()=>mapInteractive.invalidateSize(),100);
    } else {
        document.getElementById('map-interactive').classList.remove('active');
        document.getElementById('map-heatmap').classList.add('active');
        document.getElementById('heatmap-legend').style.display='block';
        setTimeout(()=>{
            mapHeatmap.invalidateSize();
            if(!heatmapLayer){
                const heatmapData = allData.filter(d=>!d.hasSite).map(d=>[d.lat,d.lon,0.8]);
                heatmapLayer = L.heatLayer(heatmapData, { 
                    radius: getDynamicRadius(mapHeatmap.getZoom()), 
                    blur: 20, 
                    maxZoom: 18,
                    max: 1.0,
                    gradient: {
                        0.0: '#0000ff',
                        0.2: '#00ffff', 
                        0.4: '#00ff00',
                        0.6: '#ffff00',
                        0.8: '#ff8000',
                        1.0: '#ff0000'
                    }
                }).addTo(mapHeatmap);
                mapHeatmap.on('zoomend', ()=>heatmapLayer.setOptions({ radius:getDynamicRadius(mapHeatmap.getZoom()) }));
            }
        },100);
    }

    if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
}

// Localiser les agences
async function localiserAgences() {
    try {
        const response = await fetch('agence_loc.csv');
        if (!response.ok) throw new Error('agence_loc.csv introuvable');
        const text = await response.text();
        const lines = text.trim().split('\n');

        for (let i = 1; i < lines.length; i++) {
            const vals = lines[i].split(',');
            if (vals.length >= 3) {
                const nom = vals[0];
                const lat = parseFloat(vals[1]);
                const lon = parseFloat(vals[2]);
                if (!isNaN(lat) && !isNaN(lon)) {
                    const iconAgence = L.divIcon({
                        html: `<div style="background:#3b82f6;width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        className: ''
                    });
                    const marker = L.marker([lat, lon], { icon: iconAgence }).addTo(mapInteractive);
                    marker.bindPopup(`<b>üè¢ ${nom}</b>`);
                }
            }
        }
        console.log('Agences charg√©es depuis agence_loc.csv');
    } catch (err) {
        console.error('Erreur lors du chargement des agences :', err);
    }
}
</script>
</body>
</html>