<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartes des Coiffeurs en Dordogne</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    height: 100vh; 
    overflow: hidden; 
    background: #F6DDB4;
    color: #4b2e27;
}
.container { display: flex; height: 100vh; }

/* === SIDEBAR === */
.sidebar { 
    width: 320px; 
    background: linear-gradient(135deg, #A22D27 0%, #C2374C 100%);
    color: #F6DDB4;
    padding: 25px; 
    overflow-y: auto; 
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
h1 { font-size: 22px; margin-bottom: 8px; font-weight: 600; }
.subtitle { font-size: 13px; opacity: 0.9; margin-bottom: 20px; }

/* === STATS BOX === */
.stats { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px; 
    margin-bottom: 20px;
}
.stat-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
.stat-value { font-weight: bold; font-size: 16px; }

/* === MAP SELECTOR === */
.map-selector { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px; 
    margin-bottom: 20px;
}
.map-selector h3 { font-size: 15px; margin-bottom: 12px; }

.map-btn {
    width: 100%; padding: 10px; margin-bottom: 8px;
    border: 2px solid rgba(246,221,180,0.3);
    background: rgba(246,221,180,0.1);
    color: #F6DDB4;
    border-radius: 8px;
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.3s;
}
.map-btn:hover { background: rgba(246,221,180,0.25); transform: translateY(-2px); }
.map-btn.active { background: #F6DDB4; color: #A22D27; border-color: #F6DDB4; }

/* === FILTERS === */
.filters { margin-bottom: 20px; }
.filter-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #F6DDB4; }
.filter-btn {
    width: 100%; padding: 10px; margin-bottom: 8px;
    border: 2px solid rgba(246,221,180,0.3);
    background: rgba(246,221,180,0.1);
    color: #F6DDB4;
    border-radius: 8px;
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.3s;
}
.filter-btn:hover { background: rgba(246,221,180,0.25); transform: translateY(-2px); }
.filter-btn.active { background: #F6DDB4; color: #A22D27; border-color: #F6DDB4; }

/* === LEGEND === */
.legend { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px;
}
.legend-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; color:#F6DDB4; }
.legend-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; }
.legend-color { width: 18px; height: 18px; border-radius: 50%; margin-right: 10px; border: 2px solid #F6DDB4; }
.with-site { background: #A6BE4C; }
.without-site { background: #A22D27; }

/* === HEATMAP LEGEND === */
.heatmap-legend { 
    background: rgba(246,221,180,0.15);
    border: 2px solid rgba(246,221,180,0.3);
    border-radius: 10px; 
    padding: 15px; 
    margin-top: 15px; 
    display:none; 
}
.heatmap-gradient { height: 20px; border-radius: 4px; margin-top: 10px; background: linear-gradient(to right, #A6BE4C, #F6DDB4, #C2374C); }
.heatmap-labels { display: flex; justify-content: space-between; font-size: 11px; margin-top: 5px; color:#F6DDB4; }

/* === MAPS === */
.maps-container { flex: 1; display: flex; flex-direction: column; }
#map-interactive, #map-heatmap { height: 100%; display: none; }
#map-interactive.active, #map-heatmap.active { display: block; }

/* === POPUPS === */
.popup-content { min-width: 200px; }
.popup-address { font-weight: 600; margin-bottom: 8px; color: #A22D27; font-size: 13px; }
.popup-siren { font-size: 12px; color: #5a463c; margin-bottom: 8px; }
.popup-site { display: flex; align-items: center; gap: 5px; font-size: 12px; }
.popup-site.has-site { color: #A6BE4C; }
.popup-site.no-site { color: #A22D27; }
.popup-link { color: #C2374C; text-decoration: none; font-size: 11px; display: block; margin-top: 6px; }
.popup-link:hover { text-decoration: underline; }

/* === LOADING === */
.loading { 
    position: absolute; top: 50%; left: 50%; 
    transform: translate(-50%, -50%); 
    background: #F6DDB4; 
    padding: 25px 40px; border-radius: 10px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
    z-index: 9999; text-align: center; 
    color: #A22D27;
}
.loading-spinner { 
    width: 40px; height: 40px; 
    border: 3px solid #f3f3f3; 
    border-top: 3px solid #A22D27; 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
    margin: 0 auto 12px; 
}
#loading-counter { font-weight: bold; font-size: 16px; margin-top: 8px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h1>üíá‚Äç‚ôÄÔ∏è Coiffeurs en Dordogne</h1>
        <p class="subtitle">Analyse de pr√©sence en ligne</p>

        <div class="stats">
            <div class="stat-item"><span>Total:</span><span class="stat-value" id="total-count">0</span></div>
            <div class="stat-item"><span>Avec site web:</span><span class="stat-value" id="with-site-count" style="color:#A6BE4C">0</span></div>
            <div class="stat-item"><span>Sans site web:</span><span class="stat-value" id="without-site-count" style="color:#A22D27">0</span></div>
        </div>

        <div class="map-selector">
            <h3>Type de carte</h3>
            <button class="map-btn active" onclick="switchMap('interactive', event)">üìç Carte interactive</button>
            <button class="map-btn" onclick="switchMap('heatmap', event)">üî• Carte de chaleur (sans site)</button>
        </div>

        <div class="filters">
            <div class="filter-title">Filtrer par:</div>
            <button class="filter-btn active" onclick="filterMarkers('all', event)">Tous les coiffeurs</button>
            <button class="filter-btn" onclick="filterMarkers('with', event)">Avec site web</button>
            <button class="filter-btn" onclick="filterMarkers('without', event)">Sans site web</button>
        </div>

        <div class="legend">
            <div class="legend-title">L√©gende</div>
            <div class="legend-item"><div class="legend-color with-site"></div><span>Avec site internet</span></div>
            <div class="legend-item"><div class="legend-color without-site"></div><span>Sans site internet</span></div>
        </div>

        <div class="heatmap-legend" id="heatmap-legend">
            <div class="legend-title">Intensit√© de la chaleur</div>
            <div class="heatmap-gradient"></div>
            <div class="heatmap-labels">
                <span>Faible</span>
                <span>√âlev√©</span>
            </div>
            <p style="font-size: 11px; margin-top: 10px; opacity: 0.9;">
                Plus la zone est rouge, plus il y a d'entreprises sans site web
            </p>
        </div>
    </div>

    <div class="maps-container">
        <div id="map-interactive" class="active"></div>
        <div id="map-heatmap"></div>
    </div>
</div>

<div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p>Chargement des donn√©es...</p>
    <p id="loading-counter">000 / 000</p>
</div>


<script>
let mapInteractive, mapHeatmap, markers = [], heatmapLayer, allData = [], currentFilter = 'all';

async function initMaps() {
    mapInteractive = L.map('map-interactive').setView([45.1847, 0.7213], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(mapInteractive);

    mapHeatmap = L.map('map-heatmap').setView([45.1847, 0.7213], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(mapHeatmap);

    try {
        const response = await fetch('data_geocoded.csv');
        if (!response.ok) throw new Error('data_geocoded.csv introuvable');
        const csvText = await response.text();
        await processData(csvText);
    } catch(e) {
        console.error(e);
        document.getElementById('loading').style.display = 'none';
    }
}

async function processData(csvText){
    const lines = csvText.trim().split('\n');
    const total = lines.length - 1;
    const counterElem = document.getElementById('loading-counter');
    const totalElem = document.getElementById('total-count');
    const withElem = document.getElementById('with-site-count');
    const withoutElem = document.getElementById('without-site-count');

    allData = [];
    let withSite = 0, withoutSite = 0;

    for(let i=1; i<lines.length; i++){
        const values = lines[i].split(',');
        if(values.length>=6){
            const lat = parseFloat(values[4]);
            const lon = parseFloat(values[5]);
            if(!isNaN(lat) && !isNaN(lon)){
                const siteWeb = values[2].trim();
                const hasSite = siteWeb.includes('http') && !siteWeb.includes('Non');
                const item = { siren: values[0], url_pappers: values[1], site_web: siteWeb, address: values[3], lat, lon, hasSite };
                allData.push(item);
                addMarker(item);

                if(hasSite) withSite++; else withoutSite++;

                // mise √† jour des compteurs en temps r√©el
                totalElem.textContent = allData.length;
                withElem.textContent = withSite;
                withoutElem.textContent = withoutSite;
                counterElem.textContent = `${i.toString().padStart(3,'0')} / ${total.toString().padStart(3,'0')}`;
            }
        }
        if(i % 50 === 0) await new Promise(r=>setTimeout(r,1));
    }

    const heatmapData = allData.filter(d=>!d.hasSite).map(d=>[d.lat,d.lon,1]);
    heatmapLayer = L.heatLayer(heatmapData, { radius:getDynamicRadius(mapHeatmap.getZoom()), blur:15, maxZoom:18, gradient:{0:'#0000ff',0.5:'#00ff00',1:'#ff0000'} }).addTo(mapHeatmap);
    mapHeatmap.on('zoomend', ()=>heatmapLayer.setOptions({ radius:getDynamicRadius(mapHeatmap.getZoom()) }));

    document.getElementById('loading').style.display='none';
}

function getDynamicRadius(zoom){ return Math.min(40, Math.max(5, zoom*3)); }

function addMarker(item){
    const color = item.hasSite?'#10b981':'#ef4444';
    const icon = L.divIcon({ html:`<div style="background-color:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>`, iconSize:[12,12], iconAnchor:[6,6], className:'' });
    const marker = L.marker([item.lat,item.lon],{icon}).addTo(mapInteractive);
    marker.bindPopup(`<div class="popup-content">
        <div class="popup-address">${item.address}</div>
        <div class="popup-siren">SIREN: ${item.siren}</div>
        <div class="popup-site ${item.hasSite?'has-site':'no-site'}">${item.hasSite?'‚úì Site web disponible':'‚úó Pas de site web'}</div>
        ${item.hasSite?`<a href="${item.site_web}" target="_blank" class="popup-link">Visiter le site ‚Üí</a>`:''}
        <a href="${item.url_pappers}" target="_blank" class="popup-link">Voir sur Pappers ‚Üí</a>
    </div>`);
    marker.itemData = item;
    markers.push(marker);
}

function filterMarkers(filter,e){
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn=>btn.classList.remove('active'));
    e.target.classList.add('active');
    markers.forEach(marker=>{
        const show = filter==='all'||(filter==='with' && marker.itemData.hasSite)||(filter==='without' && !marker.itemData.hasSite);
        show?mapInteractive.addLayer(marker):mapInteractive.removeLayer(marker);
    });
}

function switchMap(type,e){
    document.querySelectorAll('.map-btn').forEach(btn=>btn.classList.remove('active'));
    e.target.classList.add('active');
    if(type==='interactive'){
        document.getElementById('map-interactive').classList.add('active');
        document.getElementById('map-heatmap').classList.remove('active');
        document.getElementById('heatmap-legend').style.display='none';
        setTimeout(()=>mapInteractive.invalidateSize(),100);
    } else {
        document.getElementById('map-interactive').classList.remove('active');
        document.getElementById('map-heatmap').classList.add('active');
        document.getElementById('heatmap-legend').style.display='block';
        setTimeout(()=>mapHeatmap.invalidateSize(),100);
    }
}

window.onload = initMaps;
</script>
</body>
</html>
